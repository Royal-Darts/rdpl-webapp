<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>Royal Darts Premier League 2025</title>
  <meta property="og:title" content="Royal Darts Premier League 2025" />
  <meta property="og:description" content="Live results, fixtures, standings, and stats for the Royal Darts Premier League." />
  <meta property="og:image" content="logo.png" />
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:title" content="Royal Darts Premier League 2025"/>
  <meta name="twitter:description" content="Live results, fixtures, standings, and stats for India's premier darts league."/>
  <meta name="twitter:image" content="logo.png"/>
  <link rel="icon" href="logo.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@0.322.0/font/lucide.css"/>
  <meta name="theme-color" content="#171e30">
  <style>
    :root {
      --primary: #171e30;
      --primary2: #22355c;
      --primary-light: #e9f3ff;
      --accent: #38b6ff;
      --accent2: #ffc93a;
      --gold: #ffc93a;
      --silver: #bfc9da;
      --eliminated: #f55353;
      --card: #fff;
      --nav-bg: #fff;
      --nav-active: #e9f3ff;
      --table-border: #e2ecf4;
      --text: #1d253c;
      --wa-green: #25D366;
    }
    html, body { background: #f7fafd; color: var(--text); font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; min-height: 100%; height:100%; }
    body { display:flex; flex-direction:column; min-height:100vh; box-sizing: border-box; }
    header { background: linear-gradient(120deg, var(--primary2) 80%, var(--accent) 120%);
      color: #fff; padding: 1.08rem 0.5rem 1.08rem 0.5rem; text-align: left;
      display: flex; align-items: center; gap: 0.8em;
      border-bottom: 1.5px solid #b2d9fc; box-shadow: 0 3px 30px #22355c0b;
      position:sticky; top:0; z-index:10;}
    header img { height: 44px; margin-right: 0.65em; border-radius: 9px; box-shadow: 0 2px 8px #38b6ff11; }
    header .titlebox { flex:1;}
    header h1 {margin: 0; font-size: 1.15em; font-weight: 800; color: #fff; line-height: 1.09;}
    main { max-width: 540px; margin: 0 auto 120px auto; padding: 1rem 0.14rem 0.1rem 0.14rem; width:100%; flex:1;}
    .section { display: none; }
    .section.active { display: block; }
    .card {
      background: var(--card); border-radius: 18px;
      box-shadow: 0 4px 28px #c3e6ff17; margin-bottom: 1.19em;
      padding: 1.09em 0.85em 1.05em 0.85em;
    }
    .card h3 { color: var(--primary2); margin: 0 0 0.32em 0;
      font-weight: 900; font-size:1.08em; letter-spacing:0.01em; }
    .table-scroll { overflow-x: auto; width: 100%; border-radius: 12px; margin-bottom: 0.25em;}
    table { width: 100%; background: transparent; border-collapse: separate; border-spacing: 0; margin: 0; font-size: 1em; border: none;}
    th,td {
      padding: 0.61em 0.25em; text-align: center; font-size: 1.08em; border-bottom: 1px solid var(--table-border);
      background: transparent; color: var(--text); word-break: break-word; white-space: pre-line; overflow-wrap: anywhere; line-height: 1.18;
    }
    th { color: var(--primary2); font-weight:800; background:transparent; border-bottom:2px solid #b2d9fc;}
    .curl { white-space: pre-line; word-break: break-word; }
    .stand-row { background: #fff; border-radius: 8px; font-weight: 700;
      font-size: 1.08em; margin-bottom: 0.10em; position:relative; box-shadow: 0 2px 14px #38b6ff09; text-align: center;}
    .stand-row .pos-cell {font-weight:900;}
    .stand-row.gold .pos-cell {background:var(--gold)!important;color:#212b36;}
    .stand-row.silver .pos-cell {background:var(--silver)!important;color:#1a1a1a;}
    .stand-row.elim .pos-cell {background:var(--eliminated)!important;color:#fff;}
    .stand-teamlogo { width: 20px; height: 20px; border-radius: 4px; vertical-align: middle; margin-right: 7px;}
    .stand-points {font-weight:800; font-size:1.03em;}
    .stand-legend {text-align:center;font-size:0.98em;margin-bottom:0.7em;}
    .stand-legend span {display:inline-block;border-radius:4px;padding:2px 9px;margin:0 5px;font-weight:700;}
    .stand-legend .gold {background:var(--gold);color:#2e2e2e;}
    .stand-legend .silver {background:var(--silver);color:#232323;}
    .stand-legend .elim {background:#ffdbdb;color:#99111c;}
    .date-heading { color: var(--primary2); font-size: 1.22em; font-weight: 900; margin: 1.3em 0 0.12em 0; padding-bottom: 0.14em; border-bottom: 3.5px solid var(--accent); letter-spacing: 0.01em;}
    .result-row { border-left: 0px solid transparent; }
    .result-row.winner1 { border-left: 5px solid var(--gold); }
    .result-row.winner2 { border-left: 5px solid #38b6ff; }
    .winner-cell { font-weight:800; }
    .winner-icon { font-size:1.05em;vertical-align:middle;margin-left:2px;}
    .divider-cell { min-width:16px;max-width:16px;padding:0;text-align:center;vertical-align:middle;}
    .divider-line { width:2px; height:34px; background:var(--accent2); margin:0 auto; border-radius:2px; display:inline-block;}
    .squad-team-card {margin-bottom:1.25em;padding:0.8em 0.5em;border-radius:14px;background:var(--primary-light);box-shadow:0 2px 7px #38b6ff11;}
    .squad-logo-frame img {width:42px;height:42px;border-radius:10px;margin-bottom:5px;background:#fff;}
    .squad-team-name {font-weight:800;font-size:1.09em;color:var(--primary2);margin-bottom:0.19em;}
    .squad-players {display:flex;flex-wrap:wrap;gap:5px;justify-content:center;}
    .squad-player-name {background:#fff; padding:0.25em 0.6em;border-radius:7px;font-size:0.98em;box-shadow:0 1px 3px #38b6ff09;margin-bottom:2px;}
    #stats-tip {font-size:0.97em;color:var(--primary2);margin:0.38em 0 0.81em 0;text-align:center;background:#e9f3ff;border-radius:7px;padding:4px 8px;display:inline-block;}
    #stats-table th, #stats-table td { min-width: 74px; max-width: 108px;}
    #stats-table td.stat-player, #stats-table td.stat-team { white-space:pre-line; word-break:break-word; line-height:1.13; cursor:pointer;}
    #stats-table td.stat-team img {width:12px;height:12px;vertical-align:middle;margin-right:2px;}
    #player-popup { display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; z-index:250;
      background:rgba(34,53,92,0.92); justify-content:center; align-items:center;
      animation:fadeIn 0.14s; }
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    #player-popup .popup-card { background:#fff; border-radius:12px; box-shadow:0 2px 14px #b1e1ff33;
      padding:1em 1.1em; color:var(--primary-dark); min-width:230px;max-width:93vw; text-align:center; font-weight:700;position:relative;}
    #player-popup .popup-head {font-size:1.08em; font-weight:800; margin-bottom:0.18em;}
    #player-popup .popup-team {color:#22355c;font-weight:700;margin-bottom:0.18em;}
    #player-popup .popup-label {color:#212b36;font-size:0.92em;margin-top:0.11em;}
    #player-popup .popup-close {color:#222; font-size:1.2em; background:none; border:none; position:absolute;top:1.1em;right:1.1em;cursor:pointer;}
    .nav-bottom-bar {
      position: fixed; left: 0; right: 0; bottom: 0;
      background: var(--nav-bg); box-shadow: 0 -1px 12px #b1e1ff18,0 0 3px #38b6ff10;
      border-top: 1.5px solid #e2ecf4;
      width:100vw; max-width:540px; margin:auto; z-index:1000;
      display:flex; justify-content:space-around; align-items:center;
      height:54px; min-height:54px;
    }
    .nav-bottom-bar .nav-btn {
      flex: 1 1 0; display: flex; flex-direction: column; align-items: center; justify-content: center;
      border: none; background: none; padding: 4px 0 0 0; color: #4b678a;
      font-size: 0.93em; font-weight: 700; cursor: pointer; transition: background 0.12s, color 0.11s;
      border-radius: 9px; outline: none; gap: 1px;
    }
    .nav-bottom-bar .nav-btn.active, .nav-bottom-bar .nav-btn:active {
      background: var(--nav-active); color: var(--primary2); box-shadow: 0 1px 7px #38b6ff11;
    }
    .nav-bottom-bar .nav-btn .lucide { font-size: 1.33em; display:block; margin-bottom: -1px;}
    .nav-bottom-bar .nav-label { font-size: 0.75em; font-weight: 800; letter-spacing: 0.02em; }
    @media (min-width:540px) {
      .nav-bottom-bar { left: 50%; transform: translateX(-50%); }
      footer { left: 50%; transform: translateX(-50%); }
    }
    .footer-icons {margin-top:0.8rem;text-align:center;display:flex;justify-content:center;align-items:center;gap:1.25rem;}
    .footer-icons img, .footer-icons .wa-btn {
      height:22px;width:22px;vertical-align:middle;border-radius:5px;background:#fff;border:1px solid #bfe4fa;
      box-shadow:0 1px 4px rgba(0,0,0,0.04);object-fit:cover;padding:2px;
      display:inline-block;
    }
    .footer-suca {margin-top:0.7rem;text-align:center;color:#bdbdbd;font-size:0.9rem;}
    footer { width:100%;max-width:540px;margin:auto; background:none; position:fixed; bottom:54px; left:0; right:0; z-index:900; }
    @media (max-width:540px) {
      main {padding:0.62rem 0.01rem 3.6rem 0.01rem;}
      header img {height:22px;}
      .card {padding:0.52em 0.09em;}
      .date-heading {font-size: 1em;}
      th,td {font-size:0.95em;}
      table {font-size:0.97em;}
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo"/>
    <div class="titlebox">
      <h1>Royal Darts Premier League 2025</h1>
    </div>
  </header>
  <main>
    <!-- DASHBOARD -->
    <section id="dashboard" class="section active">
      <div class="card">
        <h3>Today's Fixtures</h3>
        <div class="table-scroll">
          <table class="fixtures-table" id="dashboard-fixtures-table">
            <thead>
              <tr>
                <th>Time</th>
                <th>Team 1</th>
                <th></th>
                <th>Team 2</th>
              </tr>
            </thead>
            <tbody id="dashboard-fixtures"></tbody>
          </table>
        </div>
      </div>
      <div class="card" style="margin-top:-0.7em;">
        <h3>Quick Standings</h3>
        <div class="standings-group-title">Group A</div>
        <div class="table-scroll"><table class="standings-table"><thead>
          <tr><th>Pos</th><th>Team</th><th>Pts</th></tr>
        </thead><tbody id="dashboard-standings-a"></tbody></table></div>
        <div class="standings-group-title">Group B</div>
        <div class="table-scroll"><table class="standings-table"><thead>
          <tr><th>Pos</th><th>Team</th><th>Pts</th></tr>
        </thead><tbody id="dashboard-standings-b"></tbody></table></div>
      </div>
    </section>
    <section id="fixtures" class="section"><div class="card"><h3>Fixtures</h3><div id="fixturesTableContainer"></div></div></section>
    <section id="results" class="section"><div class="card"><h3>Results</h3><div id="resultsContainer"></div></div></section>
    <section id="standings" class="section">
      <div class="card" style="margin-bottom:0.8em;">
        <div class="stand-legend">
          <span class="gold"><i class="lucide lucide-trophy" style="font-size:1.09em;vertical-align:middle;margin-right:3px;"></i>Gold Cup (Top 3)</span>
          <span class="silver"><i class="lucide lucide-award" style="font-size:1.05em;vertical-align:middle;margin-right:3px;"></i>Silver Cup (4-6)</span>
          <span class="elim"><i class="lucide lucide-x-circle" style="font-size:1.03em;vertical-align:middle;margin-right:3px;"></i>Eliminated (7-8)</span>
          <span style="margin-left:8px;">EF = Events For, EA = Events Against, ED = Events Diff</span>
        </div>
        <h3>Standings</h3>
        <div class="standings-group-title">Group A</div>
        <div id="standings-a"></div>
        <div class="standings-group-title" style="margin-top:1.2em;">Group B</div>
        <div id="standings-b"></div>
      </div>
    </section>
    <section id="squads" class="section">
      <div class="card">
        <h3>Squads</h3>
        <div id="squadsContainer" class="squad-grid"></div>
      </div>
    </section>
    <section id="stats" class="section">
      <div class="card"><h3>Player Stats</h3>
        <div id="stats-tip">Tip: Tap any player name in the table below to view and save their full player card.</div>
        <div id="stat-highlights"></div>
        <div class="team-filter-bar" id="team-filter-bar"></div>
        <input id="stats-search" type="text" placeholder="Search player or team..." style="margin-bottom:0.8em;padding:0.33em 0.49em;font-size:0.96em;width:98vw;max-width:210px;border-radius:5px;border:1px solid #e2ec
             f4;display:block;margin:auto;">
                <div id="stats-table"></div>
              </div>
            </section>
            <section id="live" class="section">
              <div class="card">
                <h3>Watch Live</h3>
                <iframe src="https://n01darts.com/n01/tournament/comp.php?id=t_NI0o_4352&tab=live" width="100%" height="420" frameborder="0" style="border-radius:12px;border:none;"></iframe>
              </div>
            </section>
          </main>
          <!-- Modern Bottom Nav Bar -->
          <nav class="nav-bottom-bar" id="main-nav">
            <button class="nav-btn active" onclick="showTab('dashboard')" id="nav-dashboard" title="Home"><span class="lucide lucide-home"></span><span class="nav-label">Home</span></button>
            <button class="nav-btn" onclick="showTab('fixtures')" id="nav-fixtures" title="Fixtures"><span class="lucide lucide-calendar-days"></span><span class="nav-label">Fixtures</span></button>
            <button class="nav-btn" onclick="showTab('results')" id="nav-results" title="Results"><span class="lucide lucide-list-start"></span><span class="nav-label">Results</span></button>
            <button class="nav-btn" onclick="showTab('standings')" id="nav-standings" title="Standings"><span class="lucide lucide-trophy"></span><span class="nav-label">Standings</span></button>
            <button class="nav-btn" onclick="showTab('squads')" id="nav-squads" title="Squads"><span class="lucide lucide-users"></span><span class="nav-label">Squads</span></button>
            <button class="nav-btn" onclick="showTab('stats')" id="nav-stats" title="Stats"><span class="lucide lucide-bar-chart"></span><span class="nav-label">Stats</span></button>
            <button class="nav-btn" onclick="showTab('live')" id="nav-live" title="Live"><span class="lucide lucide-play-circle"></span><span class="nav-label">Live</span></button>
          </nav>
          <footer>
            <div class="footer-icons">
              <a href="https://n01darts.com/n01/tournament/comp.php?id=t_NI0o_4352&tab=live" target="_blank"><img src="https://n01darts.com/favicon.ico" alt="Nakka" title="Watch Live on Nakka" /></a>
              <a href="https://www.instagram.com/royaldarts_rcgc" target="_blank"><img src="https://cdn-icons-png.flaticon.com/512/174/174855.png" alt="Instagram" title="Follow us on Instagram" /></a>
              <a href="#" class="wa-btn" id="wa-share-btn" title="Share on WhatsApp"><span class="lucide lucide-message-circle"></span></a>
            </div>
            <div class="footer-suca">Built by SUCA Analytics</div>
          </footer>
          <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
           <script>
  // --- TEAM LOGOS, API URL ---
  const TEAM_LOGOS = {
    "Balaji Darts": "team_logos/Balaji-Darts.avif",
    "Biscotti Barrels": "team_logos/Biscotti-Barrels.avif",
    "BLC High Rollers": "team_logos/BLC-High-Rollers.avif",
    "Bullseye Bandits": "team_logos/Bullseye-Bandits.avif",
    "City Knights": "team_logos/City-Knights.avif",
    "Hugo & Finn": "team_logos/Hugo-&-Finn.png",
    "Keventer Eagle Eye": "team_logos/Keventer-Eagle-Eye.avif",
    "PKS Titans": "team_logos/PKS-Titans.avif",
    "Purti Forever": "team_logos/Purti-Forever.avif",
    "Rama Darts": "team_logos/Rama-Darts.png",
    "Royals Super Knights": "team_logos/Royals-Super-Knights.avif",
    "RSV Rising Stars": "team_logos/RSV-Rising-Stars.avif",
    "The Panthers": "team_logos/The-Panthers.avif",
    "Tons of Bull": "team_logos/Tons-of-Bull.avif",
    "UGW": "team_logos/UGW.png",
    "Vyana Warriors": "team_logos/Vyana-Warriors.avif"
  };
  const API_URL = 'https://script.google.com/macros/s/AKfycby6BCE5cyBaxpz-Jt-TeRH6k5Jeq-vqelr8S7rt32e7wFjBzEvuBrYi4yPaEBz2Kari/exec';

  // --- Navigation ---
  function showTab(tabId) {
    document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    let navBtns = Array.from(document.querySelectorAll('.nav-glass-pill .nav-item'));
    navBtns.forEach(btn => {
      if(btn.innerText.toLowerCase().includes(tabId)) btn.classList.add('active');
    });
    window.scrollTo({top:0,behavior:'smooth'});
  }

  // WhatsApp Share
  document.addEventListener("DOMContentLoaded", function() {
    const waBtn = document.getElementById("wa-share-btn");
    if(waBtn) {
      waBtn.addEventListener("click", function(e){
        e.preventDefault();
        const shareUrl = window.location.href.split('?')[0];
        const msg = encodeURIComponent("Check out the Royal Darts Premier League 2025 – live results, fixtures, stats and more! " + shareUrl);
        window.open(`https://wa.me/?text=`,"_blank");
      });
    }
  });

  // --- Data ---
  let fixturesCache = [], standingsCache = [], statsCache = [], bestLegCache = [], squadsCache = [], resultsCache = [];
  let statsSortKey = null, statsSortDir = 1, statsSearchTerm = "", teamFilter = null;
  const STATS_HIDE_COLUMNS = new Set([
    "Keep", "Break", "Second Legs", "Break Legs", "Total Score", "Total Darts", "Group", "Best Leg", "Worst Leg"
  ]);

  async function loadData() {
    try {
      const res = await fetch(API_URL);
      const data = await res.json();
      fixturesCache = data.Fixtures || [];
      standingsCache = data.Standings || [];
      statsCache = (data.Stats || []).filter(row => row.Player);
      bestLegCache = (data["Best Leg"] || []).filter(row => row["Best Leg"]);
      squadsCache = data.Squads || [];
      resultsCache = data.Results || [];
      renderDashboardFixtures();
      renderDashboardStandingsTables();
      renderFixtures(fixturesCache);
      renderResults(resultsCache, fixturesCache);
      renderStandingsTables();
      renderSquads(squadsCache);
      renderStatHighlights(statsCache, bestLegCache, "stat-highlights");
      renderStats(statsCache, bestLegCache);
      renderTeamFilter(statsCache);
    } catch (err) {console.error('Failed to load data:', err);}
  }

  // --- Dashboard: Today's Fixtures (IST only) ---
  function renderDashboardFixtures() {
    const now = new Date();
    const istNow = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Kolkata"}));
    const istYear = istNow.getFullYear(), istMonth = istNow.getMonth(), istDate = istNow.getDate();
    function isISTToday(d) {
      const istD = new Date(new Date(d).toLocaleString("en-US", {timeZone: "Asia/Kolkata"}));
      return (istD.getFullYear() === istYear && istD.getMonth() === istMonth && istD.getDate() === istDate);
    }
    const todaysFixtures = fixturesCache.filter(fix => isISTToday(fix.Date));
    let html = '';
    if (!todaysFixtures.length) {
      html = `<tr><td colspan="4" style="color:var(--primary);">No fixtures today.</td></tr>`;
    } else {
      todaysFixtures.forEach(f => {
        const timeStr = new Date(f.Time).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true,timeZone:'Asia/Kolkata'});
        html += `<tr>
          <td></td>
          <td class="curl"></td>
          <td></td>
          <td class="curl"></td>
        </tr>`;
      });
    }
    document.getElementById('dashboard-fixtures').innerHTML = html;
  }

  function renderDashboardStandingsTables() {
    const A = standingsCache.filter(s => s.Group?.toUpperCase() === 'A').sort((a,b)=>b.Points-a.Points || b.LD-a.LD);
    const B = standingsCache.filter(s => s.Group?.toUpperCase() === 'B').sort((a,b)=>b.Points-a.Points || b.LD-a.LD);
    document.getElementById('dashboard-standings-a').innerHTML = quickStandingsRows(A);
    document.getElementById('dashboard-standings-b').innerHTML = quickStandingsRows(B);
  }
  function quickStandingsRows(arr) {
    return arr.map((s,i) => {
      let groupClass = i < 3 ? "gold" : i < 6 ? "silver" : "elim";
      return `<tr class="stand-row ">
        <td class="pos-cell"></td>
        <td class="curl" style="text-align:center;"><img class="stand-teamlogo" src="" alt=""></td>
        <td class="stand-points" style="text-align:center;"></td>
      </tr>`;
    }).join('');
  }

  // --- Fixtures Page ---
  function renderFixtures(fixtures) {
    const container = document.getElementById('fixturesTableContainer');
    if (!fixtures.length) {
      container.innerHTML = '<div class="table-scroll"><table><tbody><tr><td>Loading...</td></tr></tbody></table></div>';
      return;
    }
    const byDate = {};
    fixtures.forEach(f => {
      const d = new Date(f.Date).toDateString();
      if (!byDate[d]) byDate[d] = [];
      byDate[d].push(f);
    });
    let html = '';
    Object.keys(byDate).sort((a, b) => new Date(a) - new Date(b)).forEach(dateStr => {
      html += `<div class="date-heading"></div>
      <div class="table-scroll">
      <table class="fixtures-table">
        <thead>
          <tr><th>Time</th><th>Team 1</th><th></th><th>Team 2</th></tr>
        </thead>
        <tbody>`;
      byDate[dateStr].forEach(f => {
        html += `<tr>
            <td> '2-digit', minute: '2-digit' )}</td>
            <td class="curl"></td>
            <td></td>
            <td class="curl"></td>
          </tr>`;
      });
      html += `</tbody></table></div>`;
    });
    container.innerHTML = html;
  }

  // --- Results Page ---
  function renderResults(results, fixtures) {
    const fixtureDateMap = {};
    fixtures.forEach(fix => {
      const t1 = fix["Team 1"], t2 = fix["Team 2"];
      const dateStr = new Date(fix.Date).toDateString();
      fixtureDateMap[`|`] = dateStr;
      fixtureDateMap[`|`] = dateStr;
    });
    const byDate = {};
    results.forEach(r => {
      let dateVal = "";
      if (r.Date && r.Date !== "null" && r.Date !== "" && r.Date !== undefined) {
        dateVal = new Date(r.Date).toDateString();
      } else {
        const t1 = r["Team 1"], t2 = r["Team 2"];
        dateVal = fixtureDateMap[`|`] || fixtureDateMap[`|`] || "Unknown Date";
      }
      if (!byDate[dateVal]) byDate[dateVal] = [];
      byDate[dateVal].push(r);
    });
    let html = '';
    Object.keys(byDate).sort((a, b) => new Date(a) - new Date(b)).forEach(dateStr => {
      html += `<div class="date-heading"></div>
      <div class="table-scroll">
        <table class="results-table">
          <thead>
            <tr>
              <th>Avg 1</th>
              <th>Team 1</th>
              <th>Score</th>
              <th class="divider-cell"></th>
              <th>Score</th>
              <th>Team 2</th>
              <th>Avg 2</th>
            </tr>
          </thead>
          <tbody>`;
      byDate[dateStr].forEach(r => {
        const win1 = +r['Legs 1'] > +r['Legs 2'];
        const win2 = +r['Legs 2'] > +r['Legs 1'];
        let rowClass = win1 ? "winner1" : win2 ? "winner2" : "";
        html += `<tr class="result-row ">
          <td></td>
          <td class="curl""" style="text-align:center;">''</td>
          <td style="text-align:center;"''>r['Legs 1']||"0"</td>
          <td class="divider-cell"><div class="divider-line"></div></td>
          <td style="text-align:center;"''>r['Legs 2']||"0"</td>
          <td class="curl""" style="text-align:center;">''</td>
          <td></td>
        </tr>`;
      });
      html += `</tbody></table></div>`;
    });
    document.getElementById('resultsContainer').innerHTML = html || '';
  }

  // --- Standings Page ---
  function renderStandingsTables() {
    const A = standingsCache.filter(s => s.Group?.toUpperCase() === 'A').sort((a,b)=>b.Points-a.Points || b.LD-a.LD);
    const B = standingsCache.filter(s => s.Group?.toUpperCase() === 'B').sort((a,b)=>b.Points-a.Points || b.LD-a.LD);
    document.getElementById('standings-a').innerHTML = standingsTable(A);
    document.getElementById('standings-b').innerHTML = standingsTable(B);
  }
  function standingsTable(arr) {
    let html = `<div class="table-scroll"><table class="standings-table"><thead>
      <tr>
        <th>Pos</th>
        <th>Team</th>
        <th>P</th>
        <th>W</th>
        <th>L</th>
        <th>EF</th>
        <th>EA</th>
        <th>ED</th>
        <th>Pts</th>
        <th>Avg</th>
      </tr>
    </thead><tbody>`;
    arr.forEach((s,i) => {
      let groupClass = i < 3 ? "gold" : i < 6 ? "silver" : "elim";
      html += `<tr class="stand-row ">
        <td class="pos-cell"></td>
        <td class="curl" style="text-align:center;"><img class="stand-teamlogo" src="" alt=""></td>
        <td style="text-align:center;"></td>
        <td style="text-align:center;"></td>
        <td style="text-align:center;"></td>
        <td style="text-align:center;"></td>
        <td style="text-align:center;"></td>
        <td style="text-align:center;"></td>
        <td class="stand-points" style="text-align:center;"></td>
        <td style="text-align:center;"></td>
      </tr>`;
    });
    html += "</tbody></table></div>";
    return html;
  }

  // --- Squads Page ---
  function renderSquads(squads) {
    const container = document.getElementById('squadsContainer');
    if (!squads.length) { container.innerHTML = 'Loading...'; return; }
    const teams = [...new Set(squads.map(s => s.Team))];
    let html = '';
    teams.forEach(team => {
      const logo = TEAM_LOGOS[team] || "";
      const players = squads.filter(s => s.Team === team).map(p =>
        `<div class="squad-player-name curl" tabindex="0"></div>`
      ).join('');
      html += `<div class="squad-team-card">
        <div class="squad-logo-frame"><img src="" alt=""></div>
        <div class="squad-team-name curl"></div>
        <div class="squad-players"></div>
      </div>`;
    });
    container.innerHTML = html;
  }

  // --- Stats Highlights ---
  function renderStatHighlights(stats, bestLegsSheet, id="stat-highlights") {
    const defs = [
      {key:"3 Dart Avg", label:"Best 3-Dart Avg"},
      {key:"First 9 Avg", label:"Best First 9 Avg"},
      {key:"Legs Won", label:"Most Legs Won"},
      {key:"High Finish", label:"Highest Finish"}
    ];
    const eligible = stats.filter(p => Number(p["Match Played"]) >= 2);
    let html = `<div class="stat-high-bar" style="display:flex;gap:0.27em;flex-wrap:wrap;justify-content:center;">`;
    defs.forEach(def => {
      const sorted = [...eligible].sort((a,b) => +b[def.key] - +a[def.key]);
      const player = sorted[0];
      if (!player) return;
      const team = player.Team || "";
      const logo = TEAM_LOGOS[team] || "";
      let val = player[def.key] ?? "—";
      html += `<div class="stat-high-card" style="background:var(--background);border-radius:10px;padding:0.43em 0.19em;min-width:88px;max-width:110px;text-align:center;box-shadow:0 1px 4px #b1e1ff18;">
        <div class="stat-high-label" style="color:var(--accent);font-weight:700;"></div>
        <div class="stat-high-main" style="font-size:1.12em;font-weight:700;color:var(--primary);"></div>
        <div class="stat-high-player" style="font-size:0.91em;">
          " style="width:10px;height:10px;vertical-align:middle;margin-bottom:2px;"> `:""}
           <br> <span style="color:#496d8a;font-weight:600;"></span>
        </div>
      </div>`;
    });
    if (bestLegsSheet && bestLegsSheet.length) {
      let best = bestLegsSheet.sort((a,b)=>Number(a["Best Leg"])-Number(b["Best Leg"]))[0];
      const logo = TEAM_LOGOS[best.Team] || "";
      html += `<div class="stat-high-card" style="background:var(--background);border-radius:10px;padding:0.43em 0.19em;min-width:88px;max-width:110px;text-align:center;box-shadow:0 1px 4px #b1e1ff18;">
        <div class="stat-high-label" style="color:var(--accent);font-weight:700;">Best Leg</div>
        <div class="stat-high-main" style="font-size:1.12em;font-weight:700;color:var(--primary);"></div>
        <div class="stat-high-player" style="font-size:0.91em;">
          " style="width:10px;height:10px;vertical-align:middle;margin-bottom:2px;"> `:""}
           <br> <span style="color:#496d8a;font-weight:600;"></span>
        </div>
      </div>`;
    }
    html += "</div>";
    document.getElementById(id).innerHTML = html;
  }

  // --- Stats: Team Filter Dropdown ---
  function renderTeamFilter(stats) {
    const bar = document.getElementById('team-filter-bar');
    if (!stats || !stats.length) { bar.innerHTML = ''; return;}
    const allTeams = Array.from(new Set(stats.map(p => p.Team).filter(Boolean))).sort();
    let html = `<select class="team-filter-dropdown" onchange="setTeamFilter(this.value)">
      <option value="">All Teams</option>`;
    allTeams.forEach(team => {
      html += `<option value=""""></option>`;
    });
    html += `</select>`;
    bar.innerHTML = html;
  }
  window.setTeamFilter = function(team) {
    teamFilter = team || null;
    renderStats(statsCache, bestLegCache);
  };

  // --- Stats Table ---
  function renderStats(stats, bestLegsSheet) {
    const searchInput = document.getElementById('stats-search');
    if (searchInput && !searchInput._listenerAdded) {
      searchInput.addEventListener("input", () => {
        statsSearchTerm = searchInput.value.trim().toLowerCase();
        renderStats(statsCache, bestLegCache);
      });
      searchInput._listenerAdded = true;
    }
    let filteredStats = stats;
    if (teamFilter) filteredStats = filteredStats.filter(p => p.Team === teamFilter);
    if (statsSearchTerm) {
      filteredStats = filteredStats.filter(
        p => (p.Player && p.Player.toLowerCase().includes(statsSearchTerm)) ||
             (p.Team && p.Team.toLowerCase().includes(statsSearchTerm))
      );
    }
    if (statsSortKey) {
      filteredStats = [...filteredStats].sort((a, b) => {
        let v1 = a[statsSortKey], v2 = b[statsSortKey];
        let n1 = parseFloat(v1), n2 = parseFloat(v2);
        if (!isNaN(n1) && !isNaN(n2)) {
          return statsSortDir * (n1 - n2);
        } else {
          return statsSortDir * (String(v1).localeCompare(String(v2)));
        }
      });
    }
    if (filteredStats.length) {
      const wantedHeaders = Object.keys(filteredStats[0]).filter(
        h => h && h !== "" && h !== undefined && h !== null && !STATS_HIDE_COLUMNS.has(h)
      );
      let table = "<div class='table-scroll'><table><thead><tr>";
      wantedHeaders.forEach(h => {
        let dirArrow = "";
        if (statsSortKey === h) dirArrow = statsSortDir > 0 ? " ▲" : " ▼";
        table += `<th onclick="setStatsSort('')"></th>`;
      });
      table += "</tr></thead><tbody>";
      filteredStats.forEach(row => {
        table += "<tr>" + wantedHeaders.map(h => {
          let val = row[h] ?? "";
          if (h === "Win Rate (Sets)" || h === "Win Rate (Legs)") {
            val = isNaN(parseFloat(val)) ? "" : `%`;
          }
          if (h === "Player") {
            return `<td class="stat-player curl" title="" onclick="showPlayerPopup('')"></td>`;
          }
          if (h === "Team" && TEAM_LOGOS[val]) {
            return `<td class="stat-team curl" title=""><img src="" alt="" style="width:10px;height:10px;vertical-align:middle;margin-right:2px;"></td>`;
          }
          return `<td></td>`;
        }).join("") + "</tr>";
      });
      table += "</tbody></table></div>";
      document.getElementById("stats-table").innerHTML = table;
    } else {
      document.getElementById("stats-table").innerHTML = "<p>No player stats available.</p>";
    }
  }
  window.setStatsSort = function(h) {
    if (statsSortKey === h) {
      statsSortDir = -statsSortDir;
    } else {
      statsSortKey = h;
      statsSortDir = 1;
    }
    renderStats(statsCache, bestLegCache);
  };

  // --- Player popup card ---
  function showPlayerPopup(playerName) {
    let p = statsCache.find(s => s.Player === playerName);
    if (!p) return;
    let logo = p.Team && TEAM_LOGOS[p.Team] ? `<img src="" style="width:18px;height:18px;border-radius:5px;vertical-align:middle;margin-bottom:0.13em;"><br>` : "";
    let card = `<div class="popup-card" id="player-popup-card-content">
      <div class="popup-head"></div>
      <div class="popup-team"></div>
      <div style="color:var(--primary);font-size:1em;font-weight:700;">Stats</div>
      var(--accent);font-weight:600;">:</span> </div>`;
      ).join("")}
      <button id="save-card-btn" onclick="savePlayerCard(event)">Save Card as Image</button>
    </div>`;
    document.querySelector("#player-popup .popup-card").innerHTML = card;
    document.getElementById("player-popup").style.display = "flex";
  }
  window.savePlayerCard = function(e) {
    e.stopPropagation();
    let cardNode = document.getElementById("player-popup-card-content");
    html2canvas(cardNode, {backgroundColor: "#fff", scale: 3}).then(function(canvas){
      let link = document.createElement("a");
      link.download = "Player-Card.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    });
  };
  function hidePlayerPopup(e) {
    if (!e || !e.target || e.target.id === "player-popup" || e.target.classList.contains("popup-close"))
      document.getElementById("player-popup").style.display = "none";
  }

  // --- Utility: Curl name to two lines (without breaking inside words if possible)
  function curlText(txt) {
    if (!txt) return '';
    let parts = txt.split(" ");
    if (parts.length <= 1) return txt;
    let mid = Math.ceil(parts.length/2);
    return parts.slice(0,mid).join(" ")+"\n"+parts.slice(mid).join(" ");
  }

  // --- Auto Load & Refresh ---
  loadData();
  setInterval(loadData, 60000);

</script>
</body>
</html>
          </script>
        </body>