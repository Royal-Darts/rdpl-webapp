<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Royal Darts Premier League 2025</title>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/174/174855.png" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f8f8;
    }
    header {
      background-color: #121212;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    header img {
      max-height: 60px;
      vertical-align: middle;
    }
    nav {
      background-color: #1f1f1f;
      display: flex;
      overflow-x: auto;
      white-space: nowrap;
    }
    nav button {
      flex: 1;
      padding: 1rem;
      color: white;
      background: none;
      border: none;
      font-size: 1rem;
      cursor: pointer;
    }
    nav button:hover,
    nav button.active {
      background-color: #333;
    }
    main { padding: 1rem; }
    .section { display: none; }
    .section.active { display: block; }
    .table-scroll {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      width: 100%;
      margin-bottom: 2rem;
    }
    table {
      width: 100%;
      min-width: 600px;
      border-collapse: collapse;
      margin-bottom: 1.5rem;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    th, td {
      padding: 0.75rem;
      border: 1px solid #ddd;
      text-align: center;
      vertical-align: middle;
    }
    th {
      background: #ececec;
    }
    /* --- MOBILE & WRAPPING --- */
    .team-cell {
      white-space: normal !important;
      word-break: keep-all !important;
      min-width: 75px;
      max-width: 120px;
      font-size: 1rem;
      padding-left: 2px;
      padding-right: 2px;
    }
    @media (max-width: 800px) {
      table { min-width: 0; font-size: 0.93rem;}
      th, td { padding: 0.45rem; font-size: 0.93rem; }
      .team-cell { min-width: 60px; max-width: 80px; font-size: 0.98rem;}
    }
    @media (max-width: 600px) {
      header img { max-height: 50px; }
      nav button { font-size: 0.9rem; padding: 0.75rem; }
      th, td { font-size: 0.85rem; padding: 0.32rem; }
      .team-cell { min-width: 48px; max-width: 65px; font-size: 0.90rem;}
    }
    .date-heading {
      background: #181f2b;
      color: #fff;
      font-size: 1.08rem;
      font-weight: bold;
      letter-spacing: 1px;
      padding: 0.6rem 1rem;
      border-radius: 6px;
      margin: 30px 0 8px 0;
      display: inline-block;
    }
    .standings-key {
      font-size: 0.8rem;
      margin-top: 0.5rem;
      color: #444;
    }
    .group-title {
      font-size: 1.07rem;
      font-weight: 600;
      margin: 18px 0 8px 0;
      color: #21405a;
      letter-spacing: 1px;
      text-align: left;
    }
    .team-card {
      flex: 1 1 calc(25% - 1rem);
      min-width: 220px;
      background: #fff;
      padding: 1.1rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      margin-bottom: 1.5rem;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      position: relative;
    }
    .team-card-header {
      display: flex;
      align-items: center;
      margin-bottom: 0.7rem;
      gap: 0.7rem;
    }
    .team-card-header img {
      width: 38px;
      height: 38px;
      object-fit: contain;
      border-radius: 8px;
      border: 2px solid #e7e7e7;
      background: #fafbfc;
      box-shadow: 0 0 3px rgba(0,0,0,0.04);
    }
    .team-card h3 {
      font-size: 1.07rem;
      margin: 0;
      font-weight: 600;
      color: #222b4a;
      letter-spacing: 0.5px;
    }
    .team-card ul {
      margin: 0.5rem 0 0 0.2rem;
      padding: 0 0 0 18px;
      font-size: 0.99rem;
    }
    .footer-icons {
      margin-top: 0.5rem;
    }
    .footer-icons a {
      margin: 0 0.5rem;
      display: inline-block;
    }
    .footer-icons img {
      height: 24px;
      width: 24px;
    }
    @media screen and (max-width: 1000px) {
      .team-card { min-width: 180px; }
      .team-card-header img { width: 32px; height: 32px; }
    }
    @media screen and (max-width: 600px) {
      .team-card { min-width: 130px; padding: 0.65rem; }
      .team-card-header img { width: 24px; height: 24px; }
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Tournament Logo" />
    <h1>Royal Darts Premier League 2025</h1>
  </header>
  <nav>
    <button class="tab-button active" onclick="showTab('fixtures')">Fixtures</button>
    <button class="tab-button" onclick="showTab('results')">Results</button>
    <button class="tab-button" onclick="showTab('standings')">Standings</button>
    <button class="tab-button" onclick="showTab('squads')">Squads</button>
  </nav>
  <main>
    <!-- Fixtures -->
    <section id="fixtures" class="section active">
      <div id="fixturesTableContainer"></div>
    </section>
    <!-- Results -->
    <section id="results" class="section">
      <div id="resultsGroupA"></div>
      <div id="resultsGroupB"></div>
    </section>
    <!-- Standings -->
    <section id="standings" class="section">
      <div id="standingsGroupA"></div>
      <div id="standingsGroupB"></div>
      <div class="standings-key">
        <p><strong>EF</strong> = Events For, <strong>EA</strong> = Events Against, <strong>ED</strong> = Event Difference</p>
      </div>
    </section>
    <!-- Squads -->
    <section id="squads" class="section">
      <div id="squadsContainer">Loading...</div>
    </section>
  </main>
  <footer>
    Built by SUCA Analytics
    <div class="footer-icons">
      <a href="https://n01darts.com/n01/tournament/comp.php?id=t_NI0o_4352&tab=live" target="_blank">
        <img src="https://cdn-icons-png.flaticon.com/512/9131/9131529.png" alt="Live" title="Watch Live on Nakka" />
      </a>
      <a href="https://www.instagram.com/royaldarts_rcgc" target="_blank">
        <img src="https://cdn-icons-png.flaticon.com/512/174/174855.png" alt="Instagram" title="Follow us on Instagram" />
      </a>
    </div>
  </footer>
  <script>
    const TEAM_LOGOS = {
      "BLC High Rollers": "team_logos/BLC-High-Rollers.avif",
      "Balaji Darts": "team_logos/Balaji-Darts.avif",
      "Biscotti Barrels": "team_logos/Biscotti-Barrels.avif",
      "Bullseye Bandits": "team_logos/Bullseye-Bandits.avif",
      "City Knights": "team_logos/City-Knights.avif",
      "Hugo & Finn": "team_logos/Hugo-&-Finn.png",
      "Keventer Eagle Eye": "team_logos/Keventer-Eagle-Eye.avif",
      "PKS Titans": "team_logos/PKS-Titans.avif",
      "Purti Forever": "team_logos/Purti-Forever.avif",
      "Rama Darts": "team_logos/Rama-Darts.avif",
      "Royals Super Knights": "team_logos/Royals-Super-Knights.avif",
      "RSV": "team_logos/RSV.avif",
      "Panthers": "team_logos/Panthers.avif",
      "Tons of Bull": "team_logos/Tons-of-Bull.avif",
      "UGH": "team_logos/UGH.avif",
      "Vyana": "team_logos/Vyana.avif"
    };

    const API_URL = 'https://script.google.com/macros/s/AKfycbzjQ6yBNFFLbWfxyU-idb2j8XNTDrBj1C8kvWBSDaPirUNcU9jtNFxuI5s3CfgDMttA/exec';

    function showTab(tabId) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      event.target.classList.add('active');
    }

    let fixturesCache = [];

    async function loadData() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        fixturesCache = data.Fixtures || [];
        renderFixtures(data.Fixtures);
        renderResults(data.Results, fixturesCache);
        renderStandings(data.Standings);
        renderSquads(data.Squads);
      } catch (err) {
        console.error('Failed to load data:', err);
      }
    }

    // --- FIXTURES ---
    function renderFixtures(fixtures) {
      const container = document.getElementById('fixturesTableContainer');
      if (!fixtures.length) {
        container.innerHTML = '<div class="table-scroll"><table><tbody><tr><td>Loading...</td></tr></tbody></table></div>';
        return;
      }
      const byDate = {};
      fixtures.forEach(f => {
        const d = new Date(f.Date).toDateString();
        if (!byDate[d]) byDate[d] = [];
        byDate[d].push(f);
      });
      let html = '';
      Object.keys(byDate).sort((a, b) => new Date(a) - new Date(b)).forEach(dateStr => {
        html += `<div class="date-heading">${dateStr}</div>
        <div class="table-scroll">
        <table>
          <thead>
            <tr><th>Time</th><th class="team-cell">Team 1</th><th></th><th class="team-cell">Team 2</th></tr>
          </thead>
          <tbody>`;
        byDate[dateStr].forEach(f => {
          html += `<tr>
              <td>${new Date(f.Time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
              <td class="team-cell">${f['Team 1']}</td>
              <td>vs</td>
              <td class="team-cell">${f['Team 2']}</td>
            </tr>`;
        });
        html += `</tbody></table></div>`;
      });
      container.innerHTML = html;
    }

    // --- RESULTS WITH DATE & GROUP, FIX DATE BY MATCHING FIXTURES IF MISSING ---
    function renderResults(results, fixtures) {
      // Prepare a lookup for fixtures: Map "Team 1 vs Team 2" => date
      const fixtureDateMap = {};
      fixtures.forEach(fix => {
        const t1 = fix["Team 1"], t2 = fix["Team 2"];
        const dateStr = new Date(fix.Date).toDateString();
        // Both team orders for lookup
        fixtureDateMap[`${t1}|${t2}`] = dateStr;
        fixtureDateMap[`${t2}|${t1}`] = dateStr;
      });

      // For each result, ensure Date is filled by matching the teams with fixtures if needed
      const byDate = {};
      results.forEach(r => {
        let dateVal = "";
        // Try direct date from Results first
        if (r.Date && r.Date !== "null" && r.Date !== "" && r.Date !== undefined) {
          dateVal = new Date(r.Date).toDateString();
        } else {
          // Try to get from fixtures by team names (either order)
          const t1 = r["Team 1"], t2 = r["Team 2"];
          dateVal = fixtureDateMap[`${t1}|${t2}`] || fixtureDateMap[`${t2}|${t1}`] || "Unknown Date";
        }
        if (!byDate[dateVal]) byDate[dateVal] = [];
        byDate[dateVal].push(r);
      });

      let groupAHtml = '', groupBHtml = '';
      Object.keys(byDate).sort((a, b) => new Date(a) - new Date(b)).forEach(dateStr => {
        // Group A for this date
        const groupA = byDate[dateStr].filter(r => r.Group?.toUpperCase() === 'A');
        if (groupA.length) {
          groupAHtml += `<div class="date-heading">${dateStr}</div>` + resultsTable(groupA, 'A');
        }
        // Group B for this date
        const groupB = byDate[dateStr].filter(r => r.Group?.toUpperCase() === 'B');
        if (groupB.length) {
          groupBHtml += `<div class="date-heading">${dateStr}</div>` + resultsTable(groupB, 'B');
        }
      });

      document.getElementById('resultsGroupA').innerHTML = groupAHtml || '';
      document.getElementById('resultsGroupB').innerHTML = groupBHtml || '';
    }

    function resultsTable(arr, group) {
      return `
        <div class="group-title">Group ${group}</div>
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>Avg 1</th>
                <th class="team-cell">Team 1</th>
                <th>Score</th>
                <th>vs</th>
                <th>Score</th>
                <th class="team-cell">Team 2</th>
                <th>Avg 2</th>
              </tr>
            </thead>
            <tbody>
              ${arr.map(r => `<tr>
                <td>${r['Avg 1']}</td>
                <td class="team-cell">${r['Team 1']}</td>
                <td>${r['Legs 1']}</td>
                <td>vs</td>
                <td>${r['Legs 2']}</td>
                <td class="team-cell">${r['Team 2']}</td>
                <td>${r['Avg 2']}</td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>`;
    }

    // --- STANDINGS ---
    function renderStandings(standings) {
      const A = standings.filter(s => s.Group?.toUpperCase() === 'A');
      const B = standings.filter(s => s.Group?.toUpperCase() === 'B');
      const sortArr = arr => arr.sort((a, b) => b.Points - a.Points || b.LD - a.LD);
      const tableHTML = (arr, group) => `
        <div class="group-title">Group ${group}</div>
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th class="team-cell">Team</th>
                <th>P</th>
                <th>W</th>
                <th>L</th>
                <th>EF</th>
                <th>EA</th>
                <th>ED</th>
                <th>Pts</th>
                <th>Avg</th>
              </tr>
            </thead>
            <tbody>
              ${sortArr(arr).map(s => `<tr>
                <td class="team-cell">${s.Team}</td>
                <td>${s.P}</td>
                <td>${s.W}</td>
                <td>${s.L}</td>
                <td>${s.LF}</td>
                <td>${s.LA}</td>
                <td>${s.LD}</td>
                <td>${s.Points}</td>
                <td>${s.Avg}</td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>`;
      document.getElementById('standingsGroupA').innerHTML = tableHTML(A, 'A');
      document.getElementById('standingsGroupB').innerHTML = tableHTML(B, 'B');
    }

    // --- SQUADS ---
    function renderSquads(squads) {
      const container = document.getElementById('squadsContainer');
      if (!squads.length) {
        container.innerHTML = 'Loading...';
        return;
      }
      const teams = [...new Set(squads.map(s => s.Team))];
      let html = '<div style="display:flex;flex-wrap:wrap;gap:1.5rem;">';
      teams.forEach(team => {
        const logo = TEAM_LOGOS[team] || "https://via.placeholder.com/38x38?text=Logo";
        const players = squads.filter(s => s.Team === team).map(p => `<li>${p.Player}</li>`).join('');
        html += `
          <div class="team-card">
            <div class="team-card-header">
              <img src="${logo}" alt="${team} logo" onerror="this.src='https://via.placeholder.com/38x38?text=Logo'" />
              <h3>${team}</h3>
            </div>
            <ul>${players}</ul>
          </div>`;
      });
      html += '</div>';
      container.innerHTML = html;
    }

    loadData();
    setInterval(loadData, 60000);
  </script>
</body>
</html>
